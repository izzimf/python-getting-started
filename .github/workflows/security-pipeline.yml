name: Python CI - Security Scan

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  security_scan:
    runs-on: ubuntu-latest

    steps:
      # 1. Checkout code
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2. Set up Python
      - name: Set up Python 3.11
        uses: actions/setup-python@v4
        with:
          python-version: 3.11

      # 3. Install dependencies
      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install bandit

      # 4. Run Bandit, generate reports
      - name: Run Bandit SAST Scan (do not fail pipeline)
        run: |
          # install jq (for parsing json)
          sudo apt-get update && sudo apt-get install -y jq

          # run bandit: generate HTML and JSON reports
          bandit -r . -f html -o bandit-report.html -f json -o bandit-report.json || true

          # ensure reports dir exists and move reports there
          mkdir -p reports
          mv bandit-report.html reports/ || true
          mv bandit-report.json reports/ || true

          # count findings in JSON
          if [ -f reports/bandit-report.json ]; then
            ISSUES=$(jq '.results | length' reports/bandit-report.json)
          else
            echo "Bandit JSON report not found"
            ISSUES=0
          fi

          echo "Bandit findings: $ISSUES"

          # Warning in logs instead of failing pipeline
          if [ "$ISSUES" -gt 0 ]; then
            echo "::warning::Bandit found $ISSUES issues"
          fi

      # 5. Upload Bandit reports
      - name: Upload Bandit Report
        uses: actions/upload-artifact@v4
        with:
          name: bandit-report
          path: reports/
